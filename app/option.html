
<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8"><link rel="icon" href="https://jscdn.com.cn/highcharts/images/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <style>

    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>


    <script src="https://code.highcharts.com.cn/highcharts/highcharts.js"></script>
    <script src="https://code.highcharts.com.cn/highcharts/modules/exporting.js"></script>
    <script src="https://code.highcharts.com.cn/highcharts/modules/oldie.js"></script>
    <script src="https://code.highcharts.com.cn/highcharts-plugins/highcharts-zh_CN.js"></script>
    <script src="https://code.highcharts.com.cn/highcharts/themes/dark-unica.js"></script>

</head>
<body>
<div>
    <div id="container" style="max-width:99%;height:700px;margin-bottom: 1rem;"></div>

    <div class="container">
        <div class="row">
            <div class="col">
                <div class="shadow p-3 mb-3 bg-white rounded">
                    <form>
                        <div class="form-group row">
                            <div class="col-auto">
                                <label for="iptMinPrice" class="col-form-label">最低结算价</label>
                                <input type="number" class="form-control" id="iptMinPrice">
                            </div>

                            <div class="col-auto">
                                <label for="iptMaxPrice" class="col-form-label">最高结算价</label>
                                <input type="number" class="form-control" id="iptMaxPrice">
                            </div>

                            <div class="col-auto">
                                <label class="col-form-label">结算货币（Y轴）</label>

                                <div class="btn-group btn-group-toggle" data-toggle="buttons" style="width:100%;">
                                    <label class="btn btn-secondary">
                                        <input type="radio" name="optCurrencyType" value="dc" id="optCurrencyType2" checked> BTC
                                    </label>

                                    <label class="btn btn-secondary active">
                                        <input type="radio" name="optCurrencyType" value="lc" id="optCurrencyType1"> 美元
                                    </label>
                                </div>
                            </div>

                            <div class="col-auto">
                                <div style="margin-top: 2.2rem;">
                                <input type="checkbox" class="form-check-input" id="chkMakeGroupPorfit" checked>
                                <label class="form-check-label" for="chkMakeGroupPorfit">计算组合收益</label>
                                </div>
                            </div>

                            <div class="col-auto">
                                <div style="margin-top: 2.2rem; margin-left: 2rem;">
                                    <button type="button" class="btn btn-primary" id="btnChangeCommon">修 改</button>
                                </div>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <div class="shadow p-3 mb-5 bg-white rounded">
                    <h3 style="margin: 1rem">添加Option</h3>
                    <form>
                        <div class="form-group row">
                            <label for="iptPremium" class="col-sm-3 col-form-label">权利金</label>
                            <div class="col-sm-9">
                                <input type="number" class="form-control" id="iptPremium" value="0.01">
                            </div>
                        </div>

                        <div class="form-group row">
                            <label for="iptstrikePrice" class="col-sm-3 col-form-label">行权价</label>
                            <div class="col-sm-9">
                                <input type="number" class="form-control" id="iptstrikePrice" value="10000">
                            </div>
                        </div>

                        <div class="form-group row">

                            <div class="col-sm offset-3">
                                <div class="btn-group btn-group-toggle" data-toggle="buttons">
                                    <label class="btn btn-secondary active">
                                        <input type="radio" name="optCallPut" value="call" id="radioCallPut1" checked> Call 买入
                                    </label>
                                    <label class="btn btn-secondary">
                                        <input type="radio" name="optCallPut" value="put" id="radioCallPut2"> Put 卖出
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-group row">
                            <div class="col-sm offset-3">
                                <div class="btn-group btn-group-toggle" data-toggle="buttons">
                                    <label class="btn btn-secondary active">
                                        <input type="radio" name="optLongShort" value="long" id="radioLongShort1" checked> Long 看涨
                                    </label>
                                    <label class="btn btn-secondary">
                                        <input type="radio" name="optLongShort" value="short" id="radioLongShort2"> Short 看跌
                                    </label>
                                </div>
                            </div>

                        </div>


                        <div class="form-group row">
                            <div class="col-sm-10 offset-9">
                                <button type="button" class="btn btn-primary" id="btnAddOption">添加期权</button>
                            </div>
                        </div>
                    </form>

                </div>
            </div>
            <div class="col">
                <div class="shadow p-3 mb-5 bg-white rounded">
                <h3 style="margin: 1rem">Option List</h3>
                <ul id="optionContainer"></ul>
                </div>
            </div>
        </div>


    </div>


</div>

<script>

    function Option(premium, strikePrice, callPut, longShort, number) {
        this.date = ''; //行权日期
        this.strikePrice = strikePrice; //行权价
        this.callPut = callPut || 'call'; //买入call，卖出put
        this.longShort = longShort || 'long'; //看涨long，看跌short
        this.premium = premium;  //权利金
        this.number = 1;
        this.subject = 'BTC';  //标的物
        this.currency = 'USD';  //货币类型
        this.key = this.setKey();
    }


    Option.prototype = {
        _getProfit: function (price) {
            var profit;
            if (this.callPut === 'call') {
                var moneyBack = 0;
                if (this.longShort === 'long' && price > this.strikePrice) {
                    //买入看涨期权
                    //当前价格高于行权价
                    moneyBack = 1 - this.strikePrice / price;
                } else if (this.longShort === 'short' && price <= this.strikePrice) {
                    //买入看跌期权
                    //当前价格低于行权价
                    moneyBack = this.strikePrice / price - 1;
                }
                profit = moneyBack - this.premium;
            } else if (this.callPut === 'put') {
                var loss = 0;
                if (this.longShort === 'long') {
                    //卖出看涨期权
                    if (price > this.strikePrice) {
                        loss = this.strikePrice / price - 1;
                    }
                } else if (this.longShort === 'short') {
                    //卖出看跌期权
                    if (price <= this.strikePrice) {
                        loss = 1 - this.strikePrice/price;
                    }
                }
                profit = loss + this.premium;
            }
            return profit;
        },
        //返回法币计价的收益
        getProfitLc: function (price) {
            var profit = this._getProfit(price);
            return Math.round(profit * price * this.number * 100) / 100;
        },
        //返回数字货币计价的收益
        getProfitDc: function (price) {
            var profit = this._getProfit(price);
            return Math.round(profit * this.number * 10000) / 10000;
        },
        getProfit: function (price, currencyType) {
            currencyType = currencyType || 'dc';
            if (currencyType === 'dc') {
                return this.getProfitDc(price);
            } else if (currencyType === 'lc') {
                return this.getProfitLc(price);
            }
            throw "货币类型错误，必须是dc或lc";
        },
        getName: function () {
            var name = '';
            if (this.callPut === 'call') {
                name = '买入';
            } else if (this.callPut === 'put') {
                name = '卖出';
            }
            if (this.longShort === 'long') {
                name += '看涨';
            } else if (this.longShort === 'short') {
                name += '看跌';
            }
            name = this.subject + '-' + this.strikePrice + '-'  + name + '期权' + '[' + this.premium + ']';
            return name;
        },
        setKey: function () {
            var key = [this.subject, this.strikePrice, this.callPut, this.longShort,
                this.premium, this.number].join('-');
            return key.replace('.', '\\.');
        },
        getKey: function () {
            return this.key;
        }
    };

    /**
     * 投资组合
     * @constructor
     */
    function InvestGroup() {
        this.group = [];
    }

    InvestGroup.prototype = {
        setGroup: function (group) {
            this.group = group;
        },
        add: function (investment) {
            this.group.push(investment);
        },
        getProfit: function (price, currencyType) {
            var profit = 0;
            currencyType = currencyType || 'dc'; //lc 法币计价，dc 数字货币计价
            for (var i in this.group) {
                profit += this.group[i].getProfit(price, currencyType);
            }
            return profit;
        }
    };


    /**
     * 价格区间内的投资收益
     * @constructor
     */
    function PriceRange(arrInvest) {
        this.invest = null;
        this.arrInvest = null;
        this.profitLossPoint = [];
        if (arrInvest instanceof Option) {
            this.isGroup = false;
            this.invest = arrInvest;
        } else if (arrInvest instanceof Array) {
            this.isGroup = true;
            this.arrInvest = arrInvest;
        } else {
            throw "投资类型对象错误";
        }
        this.profitList = [];
    }

    PriceRange.prototype = {
        _addProfit: function (price, currencyType) {
            var profit;
            if (!this.isGroup) {
                profit = this.invest.getProfit(price, currencyType);
            } else {
                var investGroup = new InvestGroup();
                investGroup.setGroup(this.arrInvest);
                profit = investGroup.getProfit(price, currencyType);
            }
            this.profitList.push([price, profit]);
            return profit;
        },
        makeProfitForRange: function (min, max, currencyType) {
            var step = 1; //Math.round((max - min) / 1000);
            var profit, initPl, start = false;
            this.profitList = [];
            this.profitLossPoint = [];

            for (var price = min; price <= max; price += step) {
                profit = this._addProfit(price, currencyType);
                if (start === false) {
                    if (profit > 0) {
                        initPl = 'profit';
                        start = true;
                    } else if (profit < 0) {
                        initPl = 'loss';
                        start = true;
                    }
                }

                if ((initPl === 'profit' && profit <= 0) || (initPl === 'loss' && profit >= 0)) {
                    if (this.profitList[this.profitList.length-2][1] !== profit) {
                        this.profitLossPoint.push(price);
                        initPl = initPl === 'profit' ? 'loss' : 'profit';
                    }
                }

            }
            if (price < max + step) {
                this._addProfit(max, currencyType);
            }
        },
        //得到投资收益
        getProfitList: function () {
            return this.profitList;
        },
        getName: function () {
            if (!this.isGroup) {
                return this.invest.getName();
            } else {
                return '投资组合';
            }
        },
        getProfitLossPoints: function () {
            return this.profitLossPoint;
        }
    };

    function Controller() {
        this.min = 4000;
        this.max = 13000;
        this.currencyType = 'dc';
        this.options = [];
        this.arrPriceRange = [];
        this.groupPriceRange = null;
        this.chart = null;
        this.chartData = null;
        this.makeGroupPorfit = true;
        this.init();
    }

    Controller.prototype = {
        _initChart: function () {
            this.chartData = {
                credits: {
                    // enabled:true,
                    text: 'chaojidan.github.io',
                    href: 'https://chaojidan.github.io'
                },
                chart: {
                    type: 'line',
                    zoomType: 'x',
                    panning: true,
                    panKey: 'shift'
                },
                title: {
                    text: '期权投资收益曲线'
                },
                subtitle: {
                    text: ''
                },
                xAxis: {
                    type: 'linear',
                    title:{
                        text:'结算价'
                    },
                    step: 1,
                    plotLines: []
                },
                yAxis: {
                    title: {
                        text: '收益'
                    },
                    plotLines:[{
                        color:'green',
                        dashStyle:'ShortDash',
                        value:0,
                        width:2
                    }]
                },
                plotOptions: {
                    line: {
                        dataLabels: {
                            // 开启数据标签
                            enabled: false
                        },
                        // 关闭鼠标跟踪，对应的提示框、点击事件会失效
                        enableMouseTracking: true
                    },
                    series: {
                        marker: {
                            enabled: false
                        }
                    }
                },
                series:[]
            };
        },
        init: function () {
            var self = this;
            document.getElementById("btnChangeCommon").onclick = function (ev) {
                var min = parseInt(document.getElementById("iptMinPrice").value);
                var max = parseInt(document.getElementById("iptMaxPrice").value);
                var currencyType = $("input[name='optCurrencyType']:checked").val();
                self.makeGroupPorfit = document.getElementById("chkMakeGroupPorfit").checked;
                self.changeRange(min, max);
                self.changeCurrencyType(currencyType);
                self.drawChart();
            };
            document.getElementById("btnAddOption").onclick = function (ev) {
                var premium = parseFloat(document.getElementById("iptPremium").value);
                var strikePrice = parseFloat(document.getElementById("iptstrikePrice").value);
                var callPut = $("input[name='optCallPut']:checked").val();
                var longShort = $("input[name='optLongShort']:checked").val();

                var r = self.addOption(new Option(premium, strikePrice, callPut, longShort));
                if (r === true) {
                    self.drawChart();
                }
            };
            $('#optionContainer').on('click', '.btnRemOption', function () {
                self.removeOption($(this).data('key'));
                self.drawChart();
            });
            this._initChart();
        },
        changeCurrencyType: function (currencyType) {
            this.currencyType = currencyType;
        },
        changeRange: function (min, max) {
            this.min = min;
            this.max = max;
        },
        getOptionIndex: function (key) {
            for (var i  in this.options) {
                if (this.options[i].getKey() === key) {
                    return i;
                }
            }
            return false;
        },
        addOption: function (option) {
            if (this.getOptionIndex(option.getKey()) !== false) {
                alert("期权已存在");
                return false;
            }
            this.options.push(option);
            $("#optionContainer").append("<li id='opt_" + option.getKey() + "'>"+option.getName()
                +" <a href='javascript:;' class='btnRemOption' data-key='" + option.getKey() + "'>[X]</a></li>");
            return true;
        },
        removeOption: function (key) {
            this.options.splice(this.getOptionIndex[key], 1);

            $(document.getElementById('opt_' + key)).remove();
        },
        getIncome: function () {
            this.arrPriceRange = [];
            this.groupPriceRange = [];
            //生成单个投资不同结算价的收益
            for (var i in this.options) {
                this.arrPriceRange[i] = new PriceRange(this.options[i]);
                this.arrPriceRange[i].makeProfitForRange(this.min, this.max, this.currencyType);
            }

            //生成[投资组合]在不同结算价的收益
            if (this.makeGroupPorfit === true && this.options.length > 1) {
                this.groupPriceRange = new PriceRange(this.options);
                this.groupPriceRange.makeProfitForRange(this.min, this.max, this.currencyType);
            }
        },
        drawChart: function () {
            console.log(this.makeGroupPorfit);
            this.getIncome();
            this._initChart();
            document.getElementById("iptMinPrice").value = this.min;
            document.getElementById("iptMaxPrice").value = this.max;
            for (var i in this.arrPriceRange) {
                this.chartData.series[i] = {
                    name: this.arrPriceRange[i].getName(),
                    data: this.arrPriceRange[i].getProfitList()
                };
                var plPoints = this.arrPriceRange[i].getProfitLossPoints();
                for (var j in plPoints) {
                    this.chartData.xAxis.plotLines.push({
                        color: 'red',            //线的颜色，定义为红色
                        dashStyle: 'ShortDash',//标示线的样式，默认是solid（实线），这里定义为长虚线
                        value: plPoints[j],                //定义在哪个值上显示标示线，这里是在x轴上刻度为3的值处垂直化一条线
                        width: 2                 //标示线的宽度，2px
                    });
                }
            }

            //生成[投资组合]在不同结算价的收益
            if (this.makeGroupPorfit === true && this.options.length > 1) {
                this.chartData.series.push({
                    name: this.groupPriceRange.getName(),
                    data: this.groupPriceRange.getProfitList()
                });
            }
            this.chart = Highcharts.chart('container', this.chartData);
        }
    };

    controller = new Controller();
    controller.drawChart();





</script>
</body>
</html>