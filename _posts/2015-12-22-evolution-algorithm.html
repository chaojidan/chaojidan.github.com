---
layout: post
title: 进化算法
category : programming
tagline: "物竞天择 适者生存"
tags : [algorithm]
---
{% include JB/setup %}

<script src="http://cdn.bootcss.com/angular.js/1.4.8/angular.min.js"></script>

<div ng-app="evolutionApp">
    <div ng-controller="evolutionController">

    </div>
</div>

<script type="application/javascript">
    'use strict';
    angular.module('evolutionApp', [])
            .controller('evolutionController', function($scope) {
                var randomInt = function(min, max) {
                    return Math.floor(Math.random() * (max - min + 1)) + min;
                };

                //情形列表243种
                var Situation = {
                    situationMap : {},
                    status : ['empty', 'wall', 'jar'],
                    make : function() {
                        var num = 0;
                        for (var i = 0; i < this.status.length; i++) {
                            for (var j = 0; j < this.status.length; j++) {
                                for (var k = 0; k < this.status.length; k++) {
                                    for (var m = 0; m < this.status.length; m++) {
                                        for (var n = 0; n < this.status.length; n++) {
                                            var s = [this.status[i], this.status[j], this.status[k], this.status[m], this.status[n]].join(',');
                                            this.situationMap[s] = num;
                                            num++;
                                        }
                                    }
                                }
                            }
                        }
                        return this.situationMap;
                    }
                };

                //单个机器人罗比
                var Robey = function (gene) {
                    this.gene = []; //罗比的基因
                    this.init(gene);
                };
                Robey.prototype = {
                    init : function(gene) {
                        if (!gene) {
                            for (var i = 0; i < 243; i++) {
                                this.gene.push(randomInt(0, 6));
                            }
                        } else {
                            this.gene = gene;
                        }
                        //console.log(this.gene);
                        return this.gene;
                    },
                    getGene : function() {
                        return this.gene;
                    },
                    getAction : function(gene_id) {
                        return this.gene[gene_id];
                    }
                };

                //罗比所在的二维世界
                var World = function() {
                    this.height = 10;
                    this.width = 10;
                    this.fields = [];
                };
                World.prototype= {
                    init : function() {
                        for (var x = 0; x < this.width; x++) {
                            this.fields[x] = [];
                            for (var y = 0; y < this.height; y++) {
                                this.fields[x][y] = randomInt(0, 1);
                            }
                        }
                        return this.fields;
                    },
                    getField : function(x, y) {
                        return this.fields[x][y];
                    },
                    setField : function(x, y, value) {
                        this.fields[x][y] = value;
                    },
                    getHeight : function() {
                        return this.height;
                    },
                    getWidth : function() {
                        return this.width;
                    }
                };

                //单个个体的单次进化过程，得到单次适应度
                var SingleProcess = function(robey, world) {
                    this.step_num = 200;
                    this.position = {
                        x : 0,
                        y : 0
                    };
                    this.robey = robey;
                    this.world = world;
                    this.fitness = 0;
                    this.world.init();
                };
                SingleProcess.prototype = {
                    getCurrentSituation : function() {
                        var situation = [];
                        //北
                        if (this.position.y == 0) {
                            situation.push('wall');
                        } else {
                            if (this.world.getField(this.position.x, this.position.y - 1) === 1) {
                                situation.push('jar');
                            } else {
                                situation.push('empty');
                            }
                        }
                        //南
                        if (this.position.y == this.world.getHeight() - 1) {
                            situation.push('wall');
                        } else {
                            if (this.world.getField(this.position.x, this.position.y + 1) === 1) {
                                situation.push('jar');
                            } else {
                                situation.push('empty');
                            }
                        }
                        //东
                        if (this.position.x == this.world.getWidth() - 1) {
                            situation.push('wall');
                        } else {
                            if (this.world.getField(this.position.x + 1, this.position.y) === 1) {
                                situation.push('jar');
                            } else {
                                situation.push('empty');
                            }
                        }
                        //西
                        if (this.position.x == 0) {
                            situation.push('wall');
                        } else {
                            if (this.world.getField(this.position.x - 1, this.position.y) === 1) {
                                situation.push('jar');
                            } else {
                                situation.push('empty');
                            }
                        }
                        //中
                        if (this.world.getField(this.position.x, this.position.y) === 1) {
                            situation.push('jar');
                        } else {
                            situation.push('empty');
                        }
                        return situation.join(',');
                    },
                    start : function(situationMap) {
                        for (var i = 0; i < this.step_num; i++) {
                            var fitness = this.next(situationMap);
                            //console.log('step ' + i + ' 适应度:' + fitness);
                        }
                        return this.getFitness();
                    },
                    next : function(situationMap) {
                        var situation = this.getCurrentSituation();
                        //console.log('situation:', situation);
                        var gene_id;
                        //console.log(situationMap);
                        if (gene_id = situationMap[situation]) {
                            //console.log('基因id：' + gene_id);
                            var action_id = this.robey.getAction(gene_id);
                            //console.log('action_id:', action_id);
                            switch (action_id) {
                                case 0:
                                    //console.log('向北');
                                    this.moveNorthward(); //向北
                                    break;
                                case 1:
                                    //console.log('向南');
                                    this.moveSouthward(); //向南
                                    break;
                                case 2:
                                    //console.log('向东');
                                    this.moveEastward(); //向东
                                    break;
                                case 3:
                                    //console.log('向西');
                                    this.moveWestward(); //向西
                                    break;
                                case 4:
                                    //console.log('不动');
                                    this.rest(); //不动
                                    break;
                                case 5:
                                    //console.log('捡拾罐子');
                                    this.pickUpJar(); //捡拾罐子
                                    break;
                                case 6:
                                    //console.log('随机移动');
                                    this.moveRandom(); //随机移动
                                    break;
                            }
                        }
                        return this.getFitness();
                    },
                    moveNorthward : function() {
                        if (this.position.y > 0) {
                            this.position.y -= 1;
                        } else {
                            this.reduceFitness(5); //撞墙
                        }
                    },
                    moveSouthward : function() {
                        if (this.position.y < this.world.getHeight() - 1) {
                            this.position.y += 1;
                        } else {
                            this.reduceFitness(5);
                        }
                    },
                    moveEastward : function() {
                        if (this.position.x < this.world.getWidth() - 1) {
                            this.position.x += 1;
                        } else {
                            this.reduceFitness(5);
                        }
                    },
                    moveWestward : function() {
                        if (this.position.x > 0) {
                            this.position.x -= 1;
                        } else {
                            this.reduceFitness(5);
                        }
                    },
                    rest : function() {

                    },
                    pickUpJar : function() {
                        if (this.world.getField(this.position.x, this.position.y) === 1) {
                            this.addFitness(10);
                            this.world.setField(this.position.x, this.position.y, 0);
                        } else {
                            this.reduceFitness(1);
                        }
                    },
                    moveRandom : function() {
                        var methods = ['moveNorthward', 'moveSouthward', 'moveEastward', 'moveWestward'];
                        var rand = randomInt(0, 3);
                        //console.log(methods[rand]);
                        this[methods[rand]]();
                    },
                    addFitness : function(value) {
                        this.fitness += value;
                    },
                    reduceFitness : function(value) {
                        this.fitness -= value;
                    },
                    getFitness : function() {
                        return this.fitness;
                    }
                };

                //单个个体在n个世界中的进化过程，得到平均适应度
                var Process = function(id, robey) {
                    this.id = id;
                    this.robey = robey;
                    this.world_num = 100;
                    this.event = {
                        finish : null
                    };
                };
                Process.prototype = {
                    start : function(situationMap) {
                        var fitness_sum = 0;
                        for (var i = 0; i < this.world_num; i++) {
                            var singleProcess = new SingleProcess(this.robey, new World());
                            //var fitness = singleProcess.start(situationMap);
                            fitness_sum += singleProcess.start(situationMap);
                            //console.log(i, fitness);
                        }
                        var fitness_avg = Math.round(fitness_sum / this.world_num);
                        //console.log(this.id + ' fitness_sum=' + fitness_sum + ' fitness_avg=' + fitness_avg);
                        if (this.event.finish) {
                            this.event.finish(this.id, fitness_avg);
                        }
                    },
                    onFinish : function(callback) {
                        this.event.finish = callback;
                    }
                };

                //一代种群的进化，选出最优的一对基因作为父母，生出下一代，并且加入一定基因变异
                var RobeyChildren = function() {
                    this.collection = [];
                    this.situationMap = Situation.make();
                    this.finish_num = 0;
                    this.process_result = [];
                    this.event = {
                        finish : null
                    }
                };
                RobeyChildren.prototype = {
                    evolution : function(collection) {
                        var self = this;
                        this.collection = collection;
                        for (var i = 0; i < this.collection.length; i++) {
                            var process = new Process(i, this.collection[i]);
                            process.onFinish(function(id, fitness) {
                                self.emit(id, fitness);
                            });
                            process.start(this.situationMap);
                        }
                    },
                    emit : function(id, fitness) {
                        //console.log('finish:', id, fitness);
                        this.process_result.push({id : id, fitness: fitness});
                        this.finish_num++;
                        if (this.finish_num == this.collection.length) {
                            var parents = this.choiceParents();
                            //console.log(parents);
                            this.mating(parents);
                        }
                    },
                    choiceParents : function() {
                        var descSort = function(a, b) {
                            return a.fitness < b.fitness;
                        };
                        this.process_result.sort(descSort);
                        //console.log(this.process_result);
                        return this.process_result.slice(0, 2);
                    },
                    mating : function(parents) {
                        var father = this.collection[parents[0].id],
                            mother = this.collection[parents[1].id];
                        //console.log('交配', father, parents[0].fitness, mother, parents[1].fitness);
                        var n = randomInt(0, 243);
                        //繁衍后代
                        var newGene = father.getGene().slice(0, n).concat(mother.getGene().slice(n, 243));
                        //console.log(newGene);
                        //基因变异
                        var variation = randomInt(0, 243);
                        //console.log(variation, newGene[variation]);
                        newGene[variation] = randomInt(0, 6);
                        //console.log('curr:' + newGene[variation]);
                        if (this.event.finish) {
                            this.event.finish(new Robey(newGene));
                        }
                    },
                    onFinish : function(callback) {
                        this.event.finish = callback;
                    }
                };

                //生成新一代种群
                var YoungerGeneration = function() {
                    this.individual_num = 10;
                    this.childrens = [];
                    this.event = {
                        finish : null
                    }
                };
                YoungerGeneration.prototype = {
                    makeInitPopulation : function() {
                        var population = [];
                        for (var i = 0; i < this.individual_num; i++) {
                            population.push(new Robey());
                        }
                        return population;
                    },
                    start : function(population) {
                        var self = this;
                        if (!population) {
                            population = self.makeInitPopulation();
                        }
                        for (var i = 0; i < this.individual_num; i++) {
                            var robeyChildren = new RobeyChildren();
                            robeyChildren.onFinish(function(children) {
                                self.emit(children);
                            });
                            robeyChildren.evolution(population);
                        }
                    },
                    emit : function(children) {
                        this.childrens.push(children);
                        //console.log('children', children);
                        if (this.childrens.length == this.individual_num) {
                            if (this.event.finish) {
                                this.event.finish(this.childrens);
                            }
                        }
                    },
                    onFinish : function(callback) {
                        this.event.finish = callback;
                    }
                };

                var Evolution = function() {
                    this.current_generation = 0;
                    this.generation_num = 10;
                    this.event = {
                        finish : null
                    }
                };
                Evolution.prototype = {
                    start : function(childrens) {
                        var self = this;
                        console.log("第" + self.current_generation + '代');
                        if (this.generation_num <= 0) {
                            return;
                        }
                        if (this.generation_num == 1 || self.current_generation == self.generation_num - 1) {
                            var robeyChildren = new RobeyChildren();
                            robeyChildren.onFinish(function(children) {
                                self.current_generation++;
                                self.emit(children);
                            });
                            robeyChildren.evolution(childrens);
                        } else {
                            var yGeneration = new YoungerGeneration();
                            yGeneration.onFinish(function(childrens) {
                                console.log('进化结果', childrens);
                                self.current_generation++;
                                self.start(childrens);
                            });
                            yGeneration.start(childrens);
                        }
                    },
                    emit : function(children) {
                        if (this.event.finish) {
                            this.event.finish(children);
                        }
                    },
                    onFinish : function(callback) {
                        this.event.finish = callback;
                    }
                };

                var evolution = new Evolution();
                evolution.onFinish(function(children) {
                    console.log('进化完成');
                    console.log(children);
                    $scope.robey = children;
                });
                evolution.start();


            });

</script>
