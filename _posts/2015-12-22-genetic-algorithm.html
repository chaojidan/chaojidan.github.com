---
layout: post
title: 遗传算法
category : programming
tagline: "优胜劣汰 适者生存"
tags : [algorithm, genetic]
---
{% include JB/setup %}
<script language="JavaScript" type="application/javascript" src="http://cdn.bootcss.com/angular.js/1.4.8/angular.js"></script>
<script src="/assets/themes/bootstrap-3/bootstrap/js/ui-bootstrap-custom-tpls-0.14.3.min.js"></script>
<style>
    .jar {
        background: url(/images/page/jar.jpg) no-repeat 100% 100%;
    }
    .robey { width: 40px; height: 40px; margin-top: 4px;}
    p, ul li, dl dt, dl dd {
        font-size: 1em;
        font-family:  ff-tisa-web-pro-1, ff-tisa-web-pro-2, 'Lucida Grande', 'Helvetica Neue',
        Helvetica, Arial, 'Hiragino Sans GB', 'Hiragino Sans GB W3', 'Microsoft YaHei UI', 'Microsoft YaHei',
        'WenQuanYi Micro Hei', sans-serif;
        line-height: 2em;
    }
</style>
<div ng-app="evolutionApp" ng-controller="evolutionController">
    <div class="row">
        <div class="col-md-12">
            <h3>介绍</h3>
            <hr/>
            <div>
                <p>最近在看一本书，书名叫<a href="http://book.douban.com/subject/6749832/" target="_blank">《复杂》</a>，书中介绍了一个“遗传算法”（genetic algorithm），
                    让我产生了极大兴趣，刚看到一半就迫不及待的想要自己亲自试一试，熬了几个晚上终于把它实现了。</p>
                <p>这是一个模拟生物遗传进化的程序，假设机器人罗比的世界是一个10*10的网格，网格四周是墙，网格中间随机分布着一些易拉罐（每个格子最多有1个易拉罐），
                    罗比的工作就是清理这些易拉罐。</p>
                <p>每次清扫任务罗比可以执行200个动作，动作可以是以下7种：向北移动，向南移动，向西移动，向东移动，不动，捡拾罐子，随机移动。
                    每个动作都会受到奖励或惩罚，如果撞墙则扣5分并弹回原来的格子，如果执行捡拾罐子的动作但是地上却没有罐子则扣1分，
                    如果成功捡到一个罐子加10分，最后的得分称作罗比本次任务的适应度，执行若干次任务后会得到一个平均的适应度，记为当前个体的适应度，
                    适应度越高说明罗比越聪明。</p>
                <p>罗比想要获得高的得分，就必须尽可能多的收集罐子，别撞墙，没罐子的时候别去捡。</p>
                <p>这个问题很简单，人工为罗比设计一个好策略不是很难，但是我们没有这么做，而是使用遗传算法，让计算机替我们进化出来一个好策略。</p>
                <p>可以点击下面“执行任务”按钮，先有个感性认识，看看罗比是如何执行任务的，这是我手工定制的一个罗比，不是很聪明，也不是太笨，至少不会撞墙和瞎捡罐子。</p>
            </div>
        </div>
    </div>

    <div class="row" style="margin-top: 30px;">
        <div class="col-md-12">
            <h3>任务模拟</h3>
            <hr/>
        </div>
        <div class="col-md-6">
            <h4>当前罗比的策略</h4>
            <div style="height: 763px; overflow-x: auto; overflow-y: auto;
            border: 1px solid #999; border-radius : 0.5em;">
                <table class="table table-striped">
                    <tr>
                        <th>情形ID</th>
                        <th>
                            情形
                        </th>
                        <th>执行动作</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th>
                            北,南,东,西,中
                        </th>
                        <th></th>
                    </tr>
                    <tr ng-repeat="(situation, action_id) in situationMap">
                        <td>
                            <span ng-bind="action_id"></span>
                        </td>
                        <td>
                            <span ng-bind="situation|convSituation"></span>
                        </td>
                        <td>
                            <span ng-bind="robey.getAction(action_id)|convAction"></span>
                        </td>
                    </tr>
                </table>
            </div>

        </div>
        <div class="col-md-6">
            <h4>当前罗比的基因</h4>
            <form class="form">
                <textarea class="form-control" rows="7" ng-model="gene">
                </textarea>
                <p class="text-right">
                    <button type="button" class="btn btn-primary" ng-click="performTask()">执行任务</button>
                </p>
            </form>

            <h4>动画演示</h4>
            <p> 第 <strong><span ng-bind="step"></span></strong> 步，
                <strong>适应度：</strong><span ng-bind="fitness"></span>，
                <strong>情形ID（基因序号）：</strong><span ng-bind="task_return.gene_id"></span>
            </p>
            <p> <strong>动作：</strong>
                <span ng-bind="task_return.action"></span>(<span ng-bind="task_return.action_id"></span>)，
                <strong>结果：</strong> <span ng-bind="task_return.result"></span>
            </p>
            <table class="table table-bordered">
                <tr ng-repeat="y in []|range : 0 : world.width - 1">
                    <td ng-repeat="x in []|range : 0 : world.height - 1" style="height:44px; width:44px; padding: 0;">
                        <div ng-class="{jar:world.getField(x,y)}" style="width:100%;height:100%;">
                            <img ng-src="/images/page/robey.png" ng-if="x==position.x && y==position.y" class="robey">
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <div class="row" style="margin: 30px 0 30px 0;">
        <div class="col-md-12">
            <h3>算法原理</h3>
            <hr/>
        </div>
        <dl>
            <dt>第一步：制定策略</dt>
            <dd>
                <p>策略是一组规则，规则给出了在各种情形下应当采取的行动。对于罗比，它面对的情形就是它所看到的：当前格子以及东、南、西、北四个格子中的情况。
                    在各种情形下怎么做呢？罗比有7种选择：向北移动、向南移动、向西移动、向东移动、不动、捡拾罐子、随机移动。因此，罗比的策略可以写成它可能
                    遇到的所有情形以及面对每种情形应当采取的行动。</p>
                <p>有多少种情形呢？罗比看到5个格子（东、西、南、北、中），每个格子可以是空，罐和墙，这样就有 3^5 = 243种可能（其实没有这么多，因为有
                    许多不可能的情形，比如四面都是墙，不过，我们不想费劲找出所有不可能情形，只要知道其中一些永远也不可能遇到就行了）。</p>
                <p>要知道下一步怎么做，罗比只需查看策略表（参考上面的例子），查到对应的行动是往西移动，就往西移动（有可能撞墙），查到对应的行动是捡罐子
                    ，就执行捡罐子（有可能什么都捡不到）。遗传算法的目的就是让计算机自己进化出一个好的策略。</p>
            </dd>
        </dl>
        <dl>
            <dt>第二步，生成初始群体</dt>
            <dd>先生成初始群体，群体里面有200个（参数可调）随机个体，每个个体代表一种策略，每种策略有243个“<strong>基因</strong>”，每个基因是介于0-6之间的数字，
                代表一次动作（0=北移，1=南移，2=东移，3=西移，4=不动，5=捡拾罐子，6=随机移动），可以用一个数组表示，在初始群体中，基因都是用伪随机数发生器来随机设定。
            </dd>
        </dl>

        <p>PS:接下来我们就要利用初始群体进行进化，每一次进化生成新的后代群体，后代群体会继承上一代群体中的优秀基因，不断循环往复，使罗比变得越来越聪明。</p>

        <dl>
            <dt>第三步，计算群体中每个个体的适应度。</dt>
            <dd>
            <p>我们让罗比执行100次（参数可调）不同的清扫任务，每执行一次任务会得出一个本次任务的适应度，100次任务完成后会得出一个平均适应度，记为
                这个个体（策略）的适应度。</p>
            <p>每次任务开始时，我们将罗比至于位置（0,0），随机撒一些易拉罐（每个格子之多1个罐子，格子有易拉罐的概率是50%）。然后让罗比根据策略在每次任务
                中执行200个（参数可调）动作，计算出本次任务的适应度，适应度最高可能是500左右（50个左右的罐子全部捡起），最低是-1000，意味着不停的撞墙
                （撞了200次也是醉了）。</p>
            </dd>
        </dl>
        <dl>
            <dt>第四步，进化</dt>
            <dd>
                让当前群体进化，产生下一代群体，即重复以下步骤，直到新群体有200个个体：
                <ol>
                    <li>根据适应度随机选择出一对个体A和B作为父母。策略的适应度越高，被选中的概率越大。</li>
                    <li>父母交配产生两个子代个体。随机选择一个位置将两个父代的基因截断；将A的前段与B的后段合在一起生成一个子代个体，将A的后段与B的前段合在一起
                    形成另一个子代个体。</li>
                    <li>让子代个体以很小的概率产生<strong>变异</strong>。以小概率选出1个或几个数，用0到6之间的随机数替换。</li>
                    <li>将产生的两个子代个体放入新群体中。</li>
                </ol>
            </dd>
        </dl>
        <dl>
            <dt>第五步，新一代种群继续进化。</dt>
            <dd>
                <p>新群体产生200个个体后，回到第三步，对新一代种群进行处理。</p>
            </dd>
        </dl>
        <div>
            以下就是遗传算法的演示，需要注意的是，想要得出满意结果，必须有足够的个体数，要进化足够多代， 所以计算量非常大，
            相当消耗浏览器资源，长时间运行以后浏览器可能卡死，大家把数值调小一点，理解一下过程就行了。
         </div>
        <div>感谢你的关注！</div>
    </div>

    <div class="row" style="margin: 30px 0 30px 0;">

        <div class="col-md-12">
            <h3>算法演示</h3>
            <hr/>
        </div>
        <div class="col-md-12">
            <form class="form-inline">

                <div class="form-group">
                    <label for="ipt_generation">多少代</label>
                    <input type="number" class="form-control" id="ipt_generation"
                           placeholder="进化多少代"
                           ng-model="config.generation_num">
                </div>
                <div class="form-group">
                    <label for="ipt_individual_num">每代个体数</label>
                    <input type="number" class="form-control" id="ipt_individual_num"
                           placeholder="每一代个体数量"
                           ng-model="config.individual_num">
                </div>
                <div class="form-group">
                    <label for="ipt_task_num">个体任务数</label>
                    <input type="number" class="form-control" id="ipt_task_num"
                           placeholder="个体执行任务数"
                           ng-model="config.task_num">
                </div>
                <div class="form-group">
                    <label for="ipt_step_num">一次走多少步</label>
                    <input type="number" class="form-control" id="ipt_step_num"
                           placeholder="一次任务走多少步"
                           ng-model="config.step_num">
                </div>

                <div class="text-right" style="margin: 20px 20px 0 0;">
                    <div class="form-group">
                        <button type="button" class="btn btn-primary" ng-click="start()">开始进化</button>
                        <button type="button" class="btn btn-default" ng-click="stop()">终止</button>
                    </div>
                </div>


            </form>

            <div>
                <h4>进度</h4>
                <uib-progressbar class="progress-striped active" value="rateOfProgress">
                    &nbsp;<i ng-bind="rateOfProgress"></i> %
                </uib-progressbar>
            </div>
        </div>
        <div class="col-md-6">
            <h4>进度信息</h4>

            <div style="height: 300px; overflow-x: hidden; overflow-y: auto;
            border: 1px solid #999; border-radius : 0.5em;">
                <ul style="margin-top: 5px;">
                    <li ng-repeat="log in mainLogInfo track by $index">
                        <span ng-bind="log"></span>
                    </li>
                </ul>
            </div>
            <h4>进度细节 <small>（适应度后面跟着的是被选中的概率）</small></h4>
            <div style="height: 620px; overflow-x: hidden; overflow-y: auto;
            border: 1px solid #999; border-radius : 0.5em;">
                <ul style="margin-top: 5px;">
                    <li ng-repeat="log in detailLogInfo track by $index">
                        <small><span ng-bind="log"></span></small>
                    </li>
                </ul>
            </div>
        </div>
        <div class="col-md-6">
            <div>
                <h4>第<span ng-bind="lastPopulation.generation_id+1"></span>代种群基因：</h4>
                <div style="height: 500px; overflow-x: auto; overflow-y: auto;
            border: 1px solid #999; border-radius : 0.5em;">
                    <ul style="margin-top: 5px;">
                        <li ng-repeat="robey in lastPopulation.robey_list track by $index">
                            [<span ng-bind="robey.getGene()"></span>]<span ng-if="!$last">,&nbsp;&nbsp;</span>
                        </li>
                    </ul>
                </div>
            </div>

            <h4>最终进化基因</h4>
            <div style="height: 200px; border: 1px solid #999; border-radius : 0.5em;">
                <p style="word-break: break-all; word-wrap: break-word; margin:10px;" ng-bind="finalRobeyGene1"></p>
            </div>
            <div style="height: 200px; border: 1px solid #999; border-radius : 0.5em; margin-top: 20px;">
                <p style="word-break: break-all; word-wrap: break-word; margin:10px;" ng-bind="finalRobeyGene2"></p>
            </div>
        </div>

    </div>

</div>

<script type="application/javascript">
    'use strict';
    angular.module('evolutionApp', ['ui.bootstrap'])
            .controller('evolutionController', function($scope, $interval) {
                var randomInt = function(min, max) {
                    return Math.floor(Math.random() * (max - min + 1)) + min;
                };

                //情形列表243种
                var Situation = {
                    situationMap : {},
                    status : ['empty', 'wall', 'jar'],
                    make : function() {
                        var num = 0;
                        for (var i = 0; i < this.status.length; i++) {
                            for (var j = 0; j < this.status.length; j++) {
                                for (var k = 0; k < this.status.length; k++) {
                                    for (var m = 0; m < this.status.length; m++) {
                                        for (var n = 0; n < this.status.length; n++) {
                                            var s = [this.status[i], this.status[j], this.status[k], this.status[m], this.status[n]].join(',');
                                            this.situationMap[s] = num;
                                            num++;
                                        }
                                    }
                                }
                            }
                        }
                        return this.situationMap;
                    }
                };

                //单个机器人罗比
                var Robey = function (gene) {
                    this.gene = []; //罗比的基因
                    this.init(gene);
                };
                Robey.prototype = {
                    init : function(gene) {
                        if (!gene) {
                            for (var i = 0; i < 243; i++) {
                                this.gene.push(randomInt(0, 6));
                            }
                        } else {
                            if (gene.length !== 243) {
                                console.log('基因长度异常', gene);
                            }
                            this.gene = gene;
                        }
                        return this.gene;
                    },
                    getGene : function() {
                        return this.gene;
                    },
                    getAction : function(gene_id) {
                        return this.gene[gene_id];
                    }
                };

                //罗比所在的二维世界
                var World = function() {
                    this.height = 10;
                    this.width = 10;
                    this.fields = [];
                    this.init();
                };
                World.prototype= {
                    init : function() {
                        for (var x = 0; x < this.width; x++) {
                            this.fields[x] = [];
                            for (var y = 0; y < this.height; y++) {
                                this.fields[x][y] = randomInt(0, 1);
                            }
                        }
                        return this.fields;
                    },
                    getField : function(x, y) {
                        return this.fields[x][y];
                    },
                    setField : function(x, y, value) {
                        this.fields[x][y] = value;
                    },
                    getHeight : function() {
                        return this.height;
                    },
                    getWidth : function() {
                        return this.width;
                    }
                };

                //单个个体的单次进化过程，得到单次适应度
                var Task = function(task_id, robey_id, robey, situationMap, step_num, world) {
                    this.task_id = task_id;
                    this.robey_id = robey_id;
                    this.situationMap = situationMap;
                    this.step_num = step_num;
                    this.position = {
                        x : 0,
                        y : 0
                    };
                    this.robey = robey;
                    this.world = !world ? new World() : world;
                    this.fitness = 0;
                };
                Task.prototype = {
                    getCurrentSituation : function() {
                        var situation = [];
                        //北
                        if (this.position.y == 0) {
                            situation.push('wall');
                        } else {
                            if (this.world.getField(this.position.x, this.position.y - 1) === 1) {
                                situation.push('jar');
                            } else {
                                situation.push('empty');
                            }
                        }
                        //南
                        if (this.position.y == this.world.getHeight() - 1) {
                            situation.push('wall');
                        } else {
                            if (this.world.getField(this.position.x, this.position.y + 1) === 1) {
                                situation.push('jar');
                            } else {
                                situation.push('empty');
                            }
                        }
                        //东
                        if (this.position.x == this.world.getWidth() - 1) {
                            situation.push('wall');
                        } else {
                            if (this.world.getField(this.position.x + 1, this.position.y) === 1) {
                                situation.push('jar');
                            } else {
                                situation.push('empty');
                            }
                        }
                        //西
                        if (this.position.x == 0) {
                            situation.push('wall');
                        } else {
                            if (this.world.getField(this.position.x - 1, this.position.y) === 1) {
                                situation.push('jar');
                            } else {
                                situation.push('empty');
                            }
                        }
                        //中
                        if (this.world.getField(this.position.x, this.position.y) === 1) {
                            situation.push('jar');
                        } else {
                            situation.push('empty');
                        }
                        return situation.join(',');
                    },
                    start : function() {
                        var self = this;
                        for (var i = 0; i < this.step_num; i++) {
                            self.next();
                        }
                        return this.getFitness();
                    },
                    next : function() {
                        var situation = this.getCurrentSituation();
                        var r;
                        //try {
                        var gene_id = this.situationMap[situation];
                        //} catch(e) {
                        //    console.log('没有匹配的基因', situation, this.situationMap);
                        //    return;
                        //}
                        //console.log('基因id：' + gene_id);
                        var action_id = parseInt(this.robey.getAction(gene_id));
                        //console.log('action_id:', action_id);
                        switch (action_id) {
                            case 0:
                                r = this.moveNorthward(); //向北
                                break;
                            case 1:
                                r = this.moveSouthward(); //向南
                                break;
                            case 2:
                                r = this.moveEastward(); //向东
                                break;
                            case 3:
                                r = this.moveWestward(); //向西
                                break;
                            case 4:
                                r = this.rest(); //不动
                                break;
                            case 5:
                                r = this.pickUpJar(); //捡拾罐子
                                break;
                            case 6:
                                r = this.moveRandom(); //随机移动
                                break;
                            default :
                                console.log('error action_id:' + action_id, 'gene_id:' + gene_id);
                        }
                        return {
                            fitness : this.getFitness(),
                            gene_id : gene_id,
                            action_id : action_id,
                            action : r.action,
                            result : r.result
                        };

                    },
                    moveNorthward : function(rr) {
                        //console.log('个体:' + this.robey_id + ' 任务：' + this.task_id + ' 向北');
                        var r = {
                            action : (rr ? rr.action + '-' : '') + '向北移动',
                            result : ''
                        };
                        if (this.position.y > 0) {
                            this.position.y -= 1;
                        } else {
                            //console.log('个体:' + this.robey_id + ' 任务：' + this.task_id + ' 撞墙');
                            r.result = '撞墙';
                            this.reduceFitness(5); //撞墙
                        }
                        return r;
                    },
                    moveSouthward : function(rr) {
                        //console.log('个体:' + this.robey_id + ' 任务：' + this.task_id + ' 向南');
                        var r = {
                            action : (rr ? rr.action + '-' : '') + '向南移动',
                            result : ''
                        };
                        if (this.position.y < this.world.getHeight() - 1) {
                            this.position.y += 1;
                        } else {
                            //console.log('个体:' + this.robey_id + ' 任务：' + this.task_id + ' 撞墙');
                            r.result = '撞墙';
                            this.reduceFitness(5);
                        }
                        return r;
                    },
                    moveEastward : function(rr) {
                        //console.log('个体:' + this.robey_id + ' 任务：' + this.task_id + ' 向东');
                        var r = {
                            action : (rr ? rr.action + '-' : '') + '向东移动',
                            result : ''
                        };
                        if (this.position.x < this.world.getWidth() - 1) {
                            this.position.x += 1;
                        } else {
                            //console.log('个体:' + this.robey_id + ' 任务：' + this.task_id + ' 撞墙');
                            r.result = '撞墙';
                            this.reduceFitness(5);
                        }
                        return r;
                    },
                    moveWestward : function(rr) {
                        //console.log('个体:' + this.robey_id + ' 任务：' + this.task_id + ' 向西');
                        var r = {
                            action : (rr ? rr.action + '-' : '') + '向西移动',
                            result : ''
                        };
                        if (this.position.x > 0) {
                            this.position.x -= 1;
                        } else {
                            //console.log('个体:' + this.robey_id + ' 任务：' + this.task_id + ' 撞墙');
                            r.result = '撞墙';
                            this.reduceFitness(5);
                        }
                        return r;
                    },
                    rest : function() {
                        return {
                            action : '不动',
                            result : ''
                        };
                        //console.log('个体:' + this.robey_id + ' 任务：' + this.task_id + ' 不动');
                    },
                    pickUpJar : function() {
                        //console.log('个体:' + this.robey_id + ' 任务：' + this.task_id + ' 捡拾罐子');
                        var r = {
                            action : '捡拾罐子',
                            result : ''
                        };
                        if (this.world.getField(this.position.x, this.position.y) === 1) {
                            //console.log('个体:' + this.robey_id + ' 任务：' + this.task_id + ' 捡到罐子');
                            this.addFitness(10);
                            this.world.setField(this.position.x, this.position.y, 0);
                            r.result = '成功捡到罐子';
                        } else {
                            //console.log('个体:' + this.robey_id + ' 任务：' + this.task_id + ' 没捡到罐子');
                            this.reduceFitness(1);
                            r.result = '什么都没捡到';
                        }
                        return r;
                    },
                    moveRandom : function() {
                        //console.log('个体:' + this.robey_id + ' 任务：' + this.task_id + ' 随机移动');
                        var r = {
                            action : '随机移动'
                        };
                        var methods = ['moveNorthward', 'moveSouthward', 'moveEastward', 'moveWestward'];
                        var rand = randomInt(0, 3);
                        //console.log(methods[rand]);
                        return this[methods[rand]].call(this, r);
                    },
                    addFitness : function(value) {
                        this.fitness += value;
                    },
                    reduceFitness : function(value) {
                        this.fitness -= value;
                    },
                    getFitness : function() {
                        return this.fitness;
                    },
                    getPosition : function() {
                        return this.position;
                    }
                };

                //单个个体在n个任务中的进化过程，得到平均适应度
                var Process = function(id, robey, parent_gid, population_id, situationMap, task_num, step_num) {
                    this.parent_generation_id = parent_gid ? parent_gid : 0; //父代
                    this.population_id = population_id ? population_id : 0; //每次加2
                    this.id = id;
                    this.robey = robey;
                    this.situationMap = situationMap;
                    this.task_num = task_num;  //200
                    this.step_num = step_num;
                    this.curr_task_num = 0;
                    this.fitness_sum = 0;
                    this.fitness_avg = 0;
                    this.event = {
                        finish : null
                    };
                };
                Process.prototype = {
                    start : function(onFinish) {
                        var self = this;
                        self.event.finish = onFinish;
                        var t = new Date().getTime();
                        var timer = $interval(function() {
                            if (self.curr_task_num < self.task_num) {
                                var task = new Task(self.curr_task_num, self.id, self.robey, self.situationMap, self.step_num);
                                var fitness = task.start();
                                self.fitness_sum += fitness;

/*                                console.log('父代',self.parent_generation_id,
                                        '种群', self.population_id,
                                        '个体', self.id,
                                        '任务:', self.curr_task_num,
                                        '适应度：', fitness,
                                        '累计适应度', self.fitness_sum);*/

                                self.curr_task_num++;
                            } else {
                                $interval.cancel(timer);
                                self.fitness_avg = Math.round(self.fitness_sum / self.task_num);
                                var run_time = new Date().getTime() - t;
                                console.log('父代',self.parent_generation_id,
                                        '种群', self.population_id,
                                        '个体', self.id,
                                        '总适应度', self.fitness_sum,
                                        '生存次数:', self.task_num,
                                        '平均适应度', self.fitness_avg,
                                        '用时:', run_time);

                                if (self.event.finish) {
                                    self.event.finish(self.id, self.fitness_avg, run_time);
                                }
                            }
                        }, 0);
                    }
                };

                //一代种群的进化，选出最优的一对作为父母，基因遗传到下一代，并且加入一定基因变异
                var RobeyChildren = function(config) {
                    this.situationMap = config.situationMap;
                    this.parent_generation_id = config.parent_generation_id ? config.parent_generation_id : 0; //父代id
                    this.population_id = config.population_id ? config.population_id : 0; //种群id，每次加2
                    this.step_num = config.step_num;
                    this.task_num = config.task_num;

                    this.collection = [];

                    this.finish_num = 0;
                    this.process_result = [];
                    this.curr_individual_num = 0;

                    this.fitness_min = this.step_num * -5;
                    this.fitness_abs_sum = 0;

                    this.event = {
                        finish : null
                    };
                };
                RobeyChildren.prototype = {
                    multiply : function(collection, onFinish) {
                        var self = this;
                        self.collection = collection;
                        self.event.finish = onFinish;
                        //得出每个个体的平均适应度
                        var timer = $interval(function() {
                            if (self.curr_individual_num < self.collection.length) {
                                //console.log('父代',self.parent_generation_id, '种群', self.population_id, '当前个体：' , self.curr_individual_num );
                                var process = new Process(self.curr_individual_num, self.collection[self.curr_individual_num],
                                        self.parent_generation_id, self.population_id, self.situationMap, self.task_num, self.step_num);
                                process.start(function(id, fitness, run_time) {
                                    //console.log('父代',self.parent_generation_id, '种群',
                                    //        self.population_id, '当前个体：' , id, 'fitness_avg', fitness);
                                    self.emit(id, fitness, run_time);
                                });
                                self.curr_individual_num++;
                            } else {
                                $interval.cancel(timer);
                            }
                        }, 250);
                    },
                    emit : function(id, fitness, run_time) {
                        var fitness_abs = fitness - this.fitness_min;
                        this.fitness_abs_sum += fitness_abs;
                        this.process_result.push({id : id, fitness : fitness, fitness_abs : fitness_abs});
                        this.finish_num++;
                        if (this.finish_num == this.collection.length) {
                            var parents = this.choiceParents();
                            this.inherit(parents);
                        }
                    },
                    choiceParents : function() {
                        var parents = [];
/*                        this.process_result.sort(function(a, b) {
                            return a.fitness < b.fitness ? -1 : 1;
                        });*/
                        parents.push(this.probabilityChoice(this.process_result));
                        //console.log('第一个', parents[0]);

                        //console.log('第二个');
                        //console.log('fitness_abs_sum', this.fitness_abs_sum);
                        this.fitness_abs_sum -= parents[0].fitness_abs;
                        //console.log('new fitness_abs_sum', this.fitness_abs_sum);
                        //var process_list = angular.copy(this.process_result);
                        //process_list.splice(parents[0].id, 1);
                        //console.log('process_list', process_list);
                        ///console.log('parents[0].id', parents[0].id);
                        parents.push(this.probabilityChoice(this.process_result, parents[0].id));
                        return parents;
                    },
                    probabilityChoice : function(process_result, exclude_id) {
                        var rand = Math.random();
                        //console.log(rand);
                        //console.log(process_result);
                        var probability_sum = 0;
                        for (var i = 0, len = process_result.length; i < len; i++) {
                            if (i == exclude_id) {
                                //console.log('跳过'+i);
                                continue;
                            }
                            var probability = process_result[i].fitness_abs / this.fitness_abs_sum;
                            probability_sum += probability;
                            //console.log('probability', probability, probability_sum);
                            if (rand < probability_sum) {
                                //console.log('命中', process_result[i]);
                                process_result[i].probability = probability * 100;
                                return process_result[i];
                            }
                        }
                    },
                    inherit : function(parents) {
                        var r = randomInt(0, 1),
                                father = this.collection[parents[r].id],
                                mother = this.collection[parents[r===1 ? 0 : 1].id],
                                gene_length = 243;
                        var n = randomInt(0, gene_length-1);
                        //繁衍后代
                        var newGene1 = father.getGene().slice(0, n).concat(mother.getGene().slice(n));
                        //基因变异
                        var variation1 = randomInt(0, gene_length-1);
                        newGene1[variation1] = randomInt(0, 6);

                        var newGene2 = father.getGene().slice(n).concat(mother.getGene().slice(0, n));
                        var variation2 = randomInt(0, gene_length-1);
                        newGene1[variation2] = randomInt(0, 6);

                        if (this.event.finish) {
                            var childrens = [
                                {
                                    id : this.population_id,
                                    robey : new Robey(newGene1)
                                },
                                {
                                    id : this.population_id + 1,
                                    robey : new Robey(newGene2)
                                }
                            ];
                            this.event.finish(childrens, {
                                father : { fitness : parents[r].fitness, probability : parents[r].probability },
                                mother : { fitness : parents[r===1 ? 0 : 1].fitness, probability : parents[r===1 ? 0 : 1].probability }
                            });
                        }
                    }
                };

                //生成新一代种群
                var YoungerGeneration = function(config) {
                    this.situationMap = config.situationMap;
                    this.parent_generation_id = config.parent_generation_id; //父代
                    this.population_num = config.population_num ? config.population_num : 100; //最少2个种群数，也是新一代个体数
                    this.step_num = config.step_num;
                    this.task_num = config.task_num;

                    this.parent_fitness_sum = 0;
                    this.parent_fitness_avg = 0;
                    this.childrens = [];
                    this.curr_population_num = 0;
                    this.status = 0;
                    this.interval = this.population_num * 150;
                    this.event = {
                        newBabyBirth : null,
                        finish : null,
                        stop : null
                    };

                };
                YoungerGeneration.prototype = {
                    start : function(population, onNewBabyBirth, onFinish, onStop) {
                        var self = this;
                        self.event.finish = onFinish;
                        self.event.newBabyBirth = onNewBabyBirth;
                        self.event.stop = onStop;

                        //同一个种群进行population_num次繁衍，每一次繁衍生成两个新后代，做为下一代种群的一员
                        var robeyChildren = new RobeyChildren({
                            situationMap : self.situationMap,
                            parent_generation_id : self.parent_generation_id,
                            population_id : self.curr_population_num,
                            task_num : self.task_num,
                            step_num : self.step_num
                        });
                        //产生两个新后代
                        robeyChildren.multiply(population, function(childrens, parents_info) {
                            self.emit(childrens, parents_info);
                        });
                        self.curr_population_num+=2;
                        var timer = $interval(function() {
                            if (self.status !== -1 && self.curr_population_num < self.population_num) {
                                var robeyChildren = new RobeyChildren({
                                    situationMap : self.situationMap,
                                    parent_generation_id : self.parent_generation_id,
                                    population_id : self.curr_population_num,
                                    task_num : self.task_num,
                                    step_num : self.step_num
                                });
                                //产生一个新后代
                                robeyChildren.multiply(population, function(childrens, parents_info) {
                                    self.emit(childrens, parents_info);
                                });
                                self.curr_population_num+=2;
                            } else {
                                if (self.status === -1) {
                                    if (self.event.stop) {
                                        self.event.stop();
                                    }
                                }
                                $interval.cancel(timer);
                            }
                        }, this.interval);
                    },
                    emit : function(childrens, parents_info) {
/*                        if (this.status === -1) {
                            return;
                        }*/
                        this.childrens.push(childrens[0].robey);
                        this.childrens.push(childrens[1].robey);
                        this.parent_fitness_sum += parents_info.father.fitness + parents_info.mother.fitness;
                        if (this.event.newBabyBirth) {
                            this.event.newBabyBirth(childrens, parents_info);
                        }
                        if (this.childrens.length == this.population_num) {
                            this.parent_fitness_avg = Math.round(this.parent_fitness_sum / this.population_num / 2);
                            if (this.event.finish) {
                                this.event.finish(this.childrens, {
                                    fitness : this.parent_fitness_avg
                                });
                            }
                        }
                    },
                    stop : function() {
                        this.status = -1;
                    }
                };

                var Evolution = {
                    final_robeys : null,
                    current_generation : 0,
                    generation_num : 100, //繁衍多少代
                    individual_num : 100, //每一代个体数量
                    task_num : 100,  //获取平均适应度要执行多少次任务
                    step_num : 100, //每一次任务要走多少步

                    birth_individual_amount : 0, //当前诞生个体总数（用于计算进度）

                    yGeneration : null,
                    situationMap : Situation.make(),
                    event : {
                        onInit : null,
                        onGenerationStart : null,
                        onNewBabyBirth : null,
                        onGenerationFinish : null,
                        onFinish : null,
                        onWillStop : null,
                        onStop : null
                    },

                    running : false,
                    config : function(cfg) {
                        this.generation_num = cfg.generation_num;
                        this.individual_num = cfg.individual_num;
                        this.task_num = cfg.task_num;  //获取平均适应度要执行多少次任务
                        this.step_num = cfg.step_num; //每一次任务要走多少步
                        this.event = cfg.event;
                    },
                    makeInitPopulation : function(callback) {
                        var population = [],
                                self = this,
                                curr_num = 0;
                        //console.log('生成初始种群');
                        var timer = $interval(function() {
                            if (curr_num < self.individual_num) {
                                population.push(new Robey());
                                curr_num++;
                            } else {
                                $interval.cancel(timer);
                                callback(population);
                            }
                        }, 10);
                    },
                    start : function(population) {
                        var self = this;
                        if (this.generation_num <= 0) {
                            return;
                        }
                        if (this.running === true) {
                            alert('进化正在进行当中...');
                            return;
                        }
                        this.current_generation = 0;
                        this.birth_individual_amount = 0;
                        this.running = true;
                        if (!population || population.length == 0) {
                            //初始种群
                            this.makeInitPopulation(function(population) {
                                if (self.event.onInit) {
                                    self.event.onInit(0, population);
                                }
                                self.evolve(population);
                            });
                        } else {
                            if (this.event.onInit) {
                                this.event.onInit(0, population);
                            }
                            this.evolve(population);
                        }
                    },
                    evolve : function(population) {
                        var self = this;
                        if (self.event.onGenerationStart) {
                            self.event.onGenerationStart(self.current_generation + 1);
                        }
                        if (self.generation_num == 1 || self.current_generation == self.generation_num - 1) {
                            //最后一代只生成2个
                            var robeyChildren = new RobeyChildren({
                                situationMap : self.situationMap,
                                parent_generation_id : self.parent_generation_id,
                                task_num : self.task_num,
                                step_num : self.step_num
                            });
                            robeyChildren.multiply(population, function(childrens, parents_info) {
                                self.final_robeys = childrens;
                                if (self.event.onFinish) {
                                    self.event.onFinish(self.current_generation + 1, childrens, parents_info);
                                }
                                self.current_generation++;
                                self.running = false;
                            });
                        } else {
                            self.yGeneration = new YoungerGeneration({
                                situationMap : self.situationMap,
                                parent_generation_id : self.current_generation,
                                population_num : self.individual_num, //下一代个体数量同时也是上一代种群数量
                                task_num : self.task_num,
                                step_num : self.step_num
                            });
                            self.yGeneration.start(population,
                                    //诞生2个新个体
                                    function(childrens, parents_info) {
                                        self.birth_individual_amount += 2;
                                        if (self.event.onNewBabyBirth) {
                                            self.event.onNewBabyBirth.call(self, self.current_generation + 1, childrens, parents_info);
                                        }
                                    },
                                    //一个群体进化完成
                                    function(childrens, parents_info) {
                                        if (self.event.onGenerationFinish) {
                                            self.event.onGenerationFinish(self.current_generation + 1, childrens, parents_info);
                                        }
                                        self.current_generation++;
                                        self.evolve(childrens);
                                    },
                                    //进化被终止
                                    function() {
                                        if (self.event.onStop) {
                                            self.event.onStop();
                                        }
                                        self.running = false;
                                    });
                        }
                    },
                    stop : function() {
                        if (this.running === true) {
                            if (this.event.onWillStop) {
                                this.event.onWillStop();
                            }
                            console.log('程序正在终止');
                            this.yGeneration.stop();
                        }
                    }
                };

                $scope.config = {
                    generation_num : 100, //繁衍多少代
                    individual_num : 30,  //每一代个体数量
                    task_num : 100,  //获取平均适应度要执行多少次任务
                    step_num : 100 //每一次任务要走多少步
                };
                $scope.rateOfProgress = 0; //完成进度
                $scope.mainLogInfo = [];
                $scope.detailLogInfo = [];
                $scope.lastPopulation = {  //最新一个群体的基因
                    generation_id : 0,
                    robey_list : []
                };
                $scope.finalRobeyGene = null;  //最终进化基因
                var eventCallback = {
                    onInit : function(gid, population) {
                        $scope.lastPopulation.generation_id = gid;
                        $scope.lastPopulation.robey_list = population;
                    },
                    onGenerationStart : function(gid) {
                        $scope.mainLogInfo.push('第' + gid + '代繁衍开始');
                        //console.log('第' + gid + '代繁衍开始');
                    },
                    onNewBabyBirth : function(gid, robeys, parents_info) {
                        $scope.rateOfProgress = Math.round(this.birth_individual_amount / (((this.generation_num - 1) * this.individual_num + 2)) * 100);
                        $scope.detailLogInfo.push('诞生第' + (gid + 1) + '代新个体(ID：' + robeys[0].id + ' 和 ID: ' + robeys[1].id + '), 父母适应度：'
                                + parents_info.father.fitness + '(' + Math.round(parents_info.father.probability * 100) / 100 + '%)，'
                                + parents_info.mother.fitness + '(' + Math.round(parents_info.mother.probability * 100) / 100 + '%)');
                    },
                    onGenerationFinish : function(gid, childrens, parents_info) {
                        $scope.mainLogInfo.push('第' + gid + '代繁衍完成， 下一代平均适应度：' + parents_info.fitness);
                        $scope.lastPopulation.generation_id = gid;
                        $scope.lastPopulation.robey_list = childrens;
                    },
                    onFinish : function(gid, childrens, parents_info) {
                        $scope.rateOfProgress = 100;
                        console.log(childrens);
                        $scope.finalRobeyGene1 = childrens[0].robey.getGene();
                        $scope.finalRobeyGene2 = childrens[1].robey.getGene();
                        $scope.mainLogInfo.push('进化完成，适应度：父 '
                                + parents_info.father.fitness + '，母 ' + parents_info.mother.fitness);
                        //console.log('进化完成', robey);
                    },
                    onWillStop : function() {
                        $scope.mainLogInfo.push('进化即将终止');
                    },
                    onStop : function() {
                        $scope.rateOfProgress = 0;
                        $scope.mainLogInfo.push('进化被终止');
                    }
                };

                $scope.start = function () {
                    $scope.mainLogInfo.push('进化开始');
                    var config = $scope.config;
                    config.event = eventCallback;
                    Evolution.config(config);
                    Evolution.start(); //可以指定初始种群
                };
                $scope.stop = function() {
                    Evolution.stop();
                };

                $scope.gene = '6,4,5,2,4,5,3,4,5,3,4,5,4,4,5,3,4,5,2,4,5,2,4,5,3,4,5,3,4,5,0,4,5,3,4,5,3,4,5,4,4,5,3,4,5,2,4,5,2,4,5,3,4,5,1,4,5,1,4,5,3,4,5,1,4,5,1,4,5,3,4,5,2,4,5,2,4,5,3,4,5,1,4,5,1,4,5,3,4,5,0,4,5,4,4,5,3,4,5,2,4,5,2,4,5,3,4,5,4,4,5,4,4,5,3,4,5,4,4,5,4,4,5,3,4,5,2,4,5,2,4,5,3,4,5,1,4,5,1,4,5,3,4,5,1,4,5,1,4,5,3,4,5,2,4,5,2,4,5,3,4,5,0,4,5,0,4,5,3,4,5,0,4,5,0,4,5,3,4,5,2,4,5,2,4,5,3,4,5,0,4,5,0,4,5,3,4,5,0,4,5,0,4,5,3,4,5,2,4,5,2,4,5,3,4,5,1,4,5,1,4,5,3,4,5,1,4,5,1,4,5,3,4,5,2,4,5,2,4,5,3,4,5';
                $scope.world = new World();
                $scope.position = { x:0, y:0 };
                $scope.fitness = 0;
                $scope.step = 0;
                $scope.situationMap = Situation.make();
                $scope.robey = new Robey($scope.gene.split(','));
                $scope.performTask = function() {
                    var task = new Task(0, 0,  $scope.robey,  $scope.situationMap, 200, $scope.world);
                    var timer = $interval(function() {
                        if ($scope.step < 200) {
                            var r = task.next();
                            $scope.position = task.getPosition();
                            $scope.fitness = task.getFitness();
                            $scope.task_return = r;
/*                            $scope.action_id = r.action_id;
                            $scope.action = r.action;
                            $scope.result = r.result;*/
                            //console.log(fitness);
                            $scope.step++;
                        } else {

                            $interval.cancel(timer);
                        }
                    }, 1000);
                };
                //异步，时间间隔
            })
            .filter('range', function() {
                return function(input, start, total) {
                    start = angular.isNumber(start) ? parseInt(start) : 0;
                    total = angular.isNumber(total) ? parseInt(total) : 0;
                    for (var i = start; i <= total; i++)
                        input.push(i);
                    return input;
                };
            })
            .filter('convSituation', function() {
                return function(input) {
                    var s = input.replace(new RegExp("empty", 'g'), '空');
                    s = s.replace(new RegExp("wall", 'g'), '墙');
                    s = s.replace(new RegExp("jar", 'g'), '罐');
                    return s;
                };
            })
            .filter('convAction', function() {
                return function(input) {
                    var act = ['向北移动', '向南移动', '向东移动', '向西移动', '不动', '捡拾罐子', '随机移动'];

                    return act[parseInt(input)] + '(' + input + ')';
                };
            });


</script>
